## 3 - Running on EC2

For EC2, the big gotcha is that instances must be able to reach JXaaS.  So you can't
run JXaaS on your laptop and have instance reach it.  We need to run JXaaS on EC2.

Set up Juju with EC2 as normal.

Then add JXaaS to machine #0 (it doesn't have to be the same machine, but this means we
don't consume an extra machine):
```
juju deploy --to 0 cs:~justin-fathomdb/trusty/jxaas jxaas
```

Now we need to set the admin secret:

```
grep admin-secret ~/.juju/environments/amazon.jenv | cut -f 2 -d ':' | tr -d ' '
```

That should print your admin secret, which is the password for the Juju API.

We need to set that on JXaaS:

```
API_SECRET=`grep admin-secret ~/.juju/environments/amazon.jenv | cut -f 2 -d ':' | tr -d ' '`
juju set jxaas api-password=${API_SECRET}
```

Now make sure that JXaaS is exposed (NOTE: this isn't really safe yet, because
we're not yet using real authentication):

```
juju expose jxaas
```

Now let's try it out:

```
PUBLIC_ADDRESS=`juju status jxaas | grep public-address | cut -f 2 -d ':' | tr -d ' '`
echo "PUBLIC_ADDRESS is ${PUBLIC_ADDRESS}"
export JXAAS_URL=http://${PUBLIC_ADDRESS}:8080/xaas

jxaas list-instances mysql

```

Go to EC2, and open up port 8080 from your IP only. (JXaaS isn't yet secure,
so we need the IP restriction!)

In step #1, we forwarded the API port.  So, if you have the Python client
installed, you can run JXaaS commands locally.

```
export JXAAS_URL=http://54.204.195.171:8080/xaas
jxaas list-instances mysql
```


Now, let's demonstrate the proxy charm.  This allows you to consume JXaaS services easily
from within Juju.
   
```
export JXAAS_URL=http://54.204.195.171:8080/xaas
cat > /tmp/config <<EOF
mp1:
  jxaas-url: ${JXAAS_URL}
  jxaas-tenant: tenant1
  jxaas-user: user1
  jxaas-secret: secret1
EOF

juju deploy --config=/tmp/config cs:~justin-fathomdb/trusty/mysql-proxy mp1

juju deploy cs:~justin-fathomdb/trusty/mediawiki wiki1

juju status wiki1
juju status mp1

juju add-relation wiki1:db mp1:db
```

If you want to watch progress:

```
sudo tail -f  /var/log/juju-*-local/all-machines.log 
```