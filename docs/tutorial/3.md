## 3 - Running on EC2

Let's run a real XaaS: running on EC2.  Each instance will be assigned its own EC2 instance.

For EC2, the big gotcha is that instances must be able to reach JXaaS.  So you can't
run JXaaS on your laptop and have instance reach it.  We need to run JXaaS on EC2.

Set up Juju with EC2 as normal.  I recommend doing this on an EC2 instance, because it makes the
next step much more interesting (but you don't have to!)

Whether on an EC2 instance or locally, go through the normal routine for EC2 installation:

```
sudo apt-get update
sudo apt-get install --yes juju juju-local

juju generate-config

# Add your EC2 access-key and secret-key
vi ~/.juju/environments.yaml

# Deploy juju (in 64 bit mode; JXaaS is only shipped in 64 bit)
juju bootstrap --constraints "arch=amd64 mem=3G"

# That deploys to an m3.medium; if you'rd rather deploy to an m1.small do this instead:
# juju bootstrap --constraints "arch=amd64"

juju status
```

If you want to deploy everything onto m3.mediums (recommended):

```
juju set-constraints mem=3G
```


I recommend setting up a http proxy on instance 0:
TODO: Can we use the EC2 mirrors?

```
juju ssh 0 sudo apt-get install --yes squid-deb-proxy
IP=`juju ssh 0 curl http://169.254.169.254/latest/meta-data/local-ipv4`
juju set-env apt-http-proxy=http://${IP}:8000
```

Then add JXaaS to machine #0 (it doesn't have to be the same machine, but this means we
don't consume an extra machine).  This uses the charm, which uses a pre-compiled version of
jxaas (from S3), so you don't need to build it.  The deployed juju services report their status
to the jxaas server, which is why jxaas must be deployed within juju:
TODO: Can we avoid this requirement?
```
juju deploy --to 0 cs:~justin-fathomdb/trusty/jxaas jxaas
```

(Note that if you're running on LXC, it won't allow you to deploy to the same machine (?) (and you probably
aren't as concerned about any cost savings, either!), so you won't be able to use ```-to 0```)

Now we need to set the admin secret:

```
grep admin-secret ~/.juju/environments/amazon.jenv | cut -f 2 -d ':' | tr -d ' '
```

That should print your admin secret, which is the password for the Juju API.

We need to set that on JXaaS:

```
API_SECRET=`grep admin-secret ~/.juju/environments/amazon.jenv | cut -f 2 -d ':' | tr -d ' '`
juju set jxaas "api-password=${API_SECRET}"
```

Now make sure that JXaaS is exposed (NOTE: this isn't really safe yet, because
we're not yet using real authentication):

```
juju expose jxaas
```

It may take a few minutes for JXaaS to initialize all the shared components it needs. 
You can watch the status in juju status.

If the jxaas CLI isn't yet installed:

```
sudo apt-get install --yes python-pip git
sudo pip install git+https://github.com/jxaas/python-client.git
sudo pip install git+https://github.com/jxaas/cli.git
```


Now let's try it out:

```
PUBLIC_ADDRESS=`juju status jxaas | grep public-address | cut -f 2 -d ':' | tr -d ' '`
echo "PUBLIC_ADDRESS is ${PUBLIC_ADDRESS}"
export JXAAS_URL=http://${PUBLIC_ADDRESS}:8080/xaas
echo "export JXAAS_URL=http://${PUBLIC_ADDRESS}:8080/xaas"

jxaas list-instances mysql

jxaas create-instance mysql m3

jxaas list-instances mysql
```

Eventually, this should move into the started state (you can also use juju status/juju logs to see what's happening behind the scenes).

Then you should try:

```
sudo apt-get install mysql-client
jxaas connect-instance mysql m3
```


If you're going to stop here, don't forget to shut down your EC2 instances.  But if you
go on to step 4 first, there's a nice feature that can use the setup you're got now...